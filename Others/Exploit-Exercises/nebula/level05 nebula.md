# For level05 in nebula

>Check the flag05 home directory. You are looking for weak directory permissions
>  
>To do this level, log in as the level05 account with the password level05. Files for this level can be found in /home/flag05.

Remember that our goal is to execute `getflag` as user `flag05`. Everything we do must contribute towards that goal.

Let's take a look at the permissions of all the files in `/home/flag05`
```
level05@nebula:/home/flag05$ ls -la
total 5
drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 .
drwxr-xr-x 1 root   root     220 2012-08-27 07:18 ..
drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .backup
-rw-r--r-- 1 flag05 flag05   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag05 flag05  3353 2011-05-18 02:54 .bashrc
-rw-r--r-- 1 flag05 flag05   675 2011-05-18 02:54 .profile
drwx------ 2 flag05 flag05    70 2011-11-20 20:13 .ssh
```
`.backup` looks interesting. It must be something important. Let's take a look in it.
```
level05@nebula:/home/flag05/.backup$ ls -l
total 2
-rw-rw-r-- 1 flag05 flag05 1826 2011-11-20 20:13 backup-19072011.tgz
```
It is a compressed tar archive. Tar archives are commonly used to keep a backup of important files. The permissions suggest that user `level05` is able to read the tar archive, so we can extract the files from within. However, `level05` is not allowed to write to directory `/home/flag05/.backup` either. Attempting to extract the files here would result in a permission denied error.
```
level05@nebula:/home/flag05/.backup$ tar xzf backup-19072011.tgz 
tar: .ssh: Cannot mkdir: Permission denied
tar: .ssh: Cannot mkdir: Permission denied
tar: .ssh/id_rsa.pub: Cannot open: No such file or directory
tar: .ssh: Cannot mkdir: Permission denied
tar: .ssh/id_rsa: Cannot open: No such file or directory
tar: .ssh: Cannot mkdir: Permission denied
tar: .ssh/authorized_keys: Cannot open: No such file or directory
tar: Exiting with failure status due to previous errors
```

Simple. We copy `backup-19072011.tgz` into `level05`'s home directory where we have write permissions so the extraction is successful.
```
level05@nebula:~$ tar xzfv backup-19072011.tgz 
.ssh/
.ssh/id_rsa.pub
.ssh/id_rsa
.ssh/authorized_keys
```



Remember, all this is possible because of the weakly configured permissions of `/home/flag05/.backup`. `drwxr-xr-x 2 flag05 flag05` shows that `level05` can `cd` into the `.backup` and list its contents, giving us the opportunity to `cp` the backup tar archive into our home directory.


### Obtained SSH keys

SSH authentication can be done in two ways. Either by password, or by key-based authentication. A simple google search reveals the following:

- `id_rsa` contains the private key of the RSA key pair
- `id_rsa.pub` contains the public key of the RSA key pair
- `authorized_keys` contains the public key of RSA key pairs authorised to use for authenticating clients connecting to the server.

These three files are used in key-based authentication.

>SSH key pairs are two cryptographically secure keys that can be used to authenticate a client to an SSH server. Each key pair consists of a public key and a private key.
>  
>The private key is retained by the client and should be kept absolutely secret. Any compromise of the private key will allow the attacker to log into servers that are configured with the associated public key without additional authentication. As an additional precaution, the key can be encrypted on disk with a passphrase.
[source](https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server)

With ownership of the private key of the key pair, we are now able to ssh into a system as the user who has the`id_rsa.pub` public key. 

Since the backup tar archive came from user `flag05`, I guess it's safe to assume that `id_rsa.pub` is `flag05`'s public key. If I am correct, we can log in as `flag05`. So let's try!
```
level05@nebula:~$ ssh flag05@localhost
The authenticity of host 'localhost (127.0.0.1)' can't be established.
ECDSA key fingerprint is ea:8d:09:1d:f1:69:e6:1e:55:c7:ec:e9:76:a1:37:f0.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'localhost' (ECDSA) to the list of known hosts.
  
      _   __     __          __     
     / | / /__  / /_  __  __/ /___ _
    /  |/ / _ \/ __ \/ / / / / __ `/
   / /|  /  __/ /_/ / /_/ / / /_/ / 
  /_/ |_/\___/_.___/\__,_/_/\__,_/  
                                    
    exploit-exercises.com/nebula


For level descriptions, please see the above URL.

To log in, use the username of "levelXX" and password "levelXX", where
XX is the level number.

Currently there are 20 levels (00 - 19).


Welcome to Ubuntu 11.10 (GNU/Linux 3.0.0-12-generic i686)

 * Documentation:  https://help.ubuntu.com/
New release '12.04 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

flag05@nebula:~$ getflag
You have successfully executed getflag on a target account
flag05@nebula:~$ 
```
As expected, we successfully logged in and executed `getflag` as `flag05`


### Extra fun fact

>When extracting an archive, do not attempt to preserve the owner specified in the tar archive. This the default behavior for ordinary users. 
[source](https://www.gnu.org/software/tar/manual/tar.html#SEC137)

I realised `level05` owns the extracted members of `backup-19072011.tgz` even though `nebula` is the actual owner of the members.

This is the permissions of the files after being extracted from `backup-19072011.tgz`.
```
-rw-rw-r-- 1 level05 level05 1826 2018-04-01 13:29 backup-19072011.tgz
drwxr-xr-x 1 level05 level05  120 2018-04-01 13:35 .ssh
-rw-r--r-- 1 level05 level05  394 2011-07-19 02:37 authorized_keys
-rw------- 1 level05 level05 1675 2011-07-19 02:37 id_rsa
-rw-r--r-- 1 level05 level05  394 2011-07-19 02:37 id_rsa.pub
``` 

I added `--same-owner` so the owner specified in the tar archive would be preserved. That way, I can see who is the real owner of the members of the tar archive.
```
level05@nebula:/home/flag05$ tar xzf .backup/backup-19072011.tgz -C ~ --same-owner
tar: .ssh/id_rsa.pub: Cannot change ownership to uid 1000, gid 1000: Operation not permitted
tar: .ssh/id_rsa: Cannot change ownership to uid 1000, gid 1000: Operation not permitted
tar: .ssh/authorized_keys: Cannot change ownership to uid 1000, gid 1000: Operation not permitted
tar: .ssh: Cannot change ownership to uid 1000, gid 1000: Operation not permitted
```
The user with UID 1000 is `nebula`. 
```
level05@nebula:/home/flag05$ cat /etc/passwd | grep "1000"
nebula:x:1000:1000:nebula,,,:/home/nebula:/bin/bash
```
This proves that even though `nebula` is the real owner of the `.ssh` files, because `tar` does not preserve the owner specified in the tar archive when extracting, the owner of the extracted files becomes the user who invoked `tar`, which in this case is `level05`.

END
